# loveuser召回

## 数据准备部分

1. （sql）从hive里面拉候选集：大数据那边每天出一张表（来源于媒资和审核部门），这张表包含了哪些视频处于可推荐状态，哪些视频处于审核或者过期删除状态，用这张表去join视频信息表，对于每条可推荐的视频，获取视频的一些基本信息例如作者，类别，创建时间，再去join曝光记录的表，查询出这些视频的播放量，播放时长等信息，然后把查询结果拉下来
2. （python）用视频作者做key，把这个作者下的所有视频和视频的信息弄到一个list里面，然后序列化成json写到redis里面去，用的时候直接根据视频作者把所有的视频+信息拉下来

## 在线服务部分

1. 首先从画像服务中取出用户5分钟，30分钟，60分钟，天级，四个组的作者画像，每一个作者都有自己的观看时长，根据这个时长对作者进行打分，注意这个时长是要归一化的，用当前组中最大的观看时长归一化。注意5分钟组的权重是1，30是0.75，60是0.5....，如果有重复的作者，分数也要重复加的
2. 然后针对每个作者申请一个list，把这个作者的所有视频都拉下来（上面数据准备部分中的2），然后再针对每一个视频做一次过滤，如果召回规定了频道，这里要过滤掉不属于这个频道的视频，然后在针对每个视频打分。打分公式：`log(play_count + 10) / log(current_time - create_time) `，然后得到一个`pair：<content_id, score> `放到这个作者的list里面
3. 注意对于每个作者近一周创建的视频，把score打到最大以在后面实现强插。最终把每个作者的视频按照打分降序
4. 最后蛇形取结果，注意loveuser这里是走精排的，所以其实最后的分数已经无所谓了，但是之前的分数是很重要的，因为之前的分数是为了让一个作者的所有视频有先后顺序。这里蛇形取出的结果，每一轮只取一个作者的一条视频，而且按顺序取得分较高的。**注意作者与作者之间的视频不排序！！！！**，最后取到规定条数后打散（近一步说明作者与作者之间是没有排序的）
5. loveuser也做了一个push，这里push会有一个可以push的candidates存在Redis里面，每小时要从redis拉下来一下，从loveuser这个策略中获得的待push的内容要用那个candidates过滤一下，不在那个candidates里面的就过滤掉