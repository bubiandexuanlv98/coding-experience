

## AOF 日志

AOF是写后日志，区别于MySQL里面的Redo log，那个是写前日志。

写后日志就是指，先写数据库，再写内存，这样就不用额外检测这条命令对不对了。MySQL里面写前日志是因为，它的检测是在server层的，写日志是在InnoDB层，InnDB不用做命令合法性检测。

### AOF 日志结构

<img src="/Users/yixia/Desktop/coding-experience/干死小公司妈的/图片/4d120bee623642e75fdf1c0700623a9f.webp"  style="zoom:10%"  />

“*3”表示当前命令有三个部分，每部分都是由“$+数字”开头，后面紧跟着具体的命令、键或值。这里，“数字”表示这部分中的命令、键或值一共有多少字节。

### AOF 日志写回

#### 写回过程

有几个要点注意一下：

1. AOF日志写回是在主线程里面操作的，这就意味着会存在阻塞
2. AOF日志写回是写完内存以后再执行的，因此不会阻塞当前操作，但有可能对下一个操作造成影响（redis数据库操作是单线程）

#### 写回策略

1. Always，同步写回：每个写命令执行完，立马同步地将日志写回磁盘；
2. Everysec，每秒写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，每隔一秒把缓冲区中的内容写入磁盘；
3. No，操作系统控制的写回：每个写命令执行完，只是先把日志写到 AOF 文件的内存缓冲区，由操作系统决定何时将缓冲区内容写回磁盘。

#### 写回问题

1. 很显然如果写日志的时候宕机了，那么内存里面存在的但没写日志的那部分就没了，即使同步写回也有丢失一条记录的风险
2. AOF文件过大造成写回速度慢，同时有可能操作系统也不允许那么大的文件。同时宕机以后的恢复那么多条命令恢复起来也太慢

针对第二个问题AOF日志提供了一个日志重写机制

### AOF 日志重写

简单来说AOF日志重写就是把AOF日志压缩了，多条操作变一条，只记录最后的结果

#### 实现过程

AOF 重写机制就是在重写时，Redis 根据数据库的现状创建一个新的 AOF 文件，也就是说，读取数据库中的所有键值对，然后对每一个键值对用一条命令记录它的写入。

重写的过程总结为“**一个拷贝，两处日志**”。一个拷贝的目的是让重写过程非阻塞，两处日志保证了在重写过程中新来的命令第一不会丢失，第二可以顺利的写到重写日志里面去

1. 一个拷贝：每次执行重写时，主线程 fork 出后台的 bgrewriteaof 子进程。此时，操作系统会把主线程的内存拷贝一份给子进程，这里面就包含了数据库的最新数据。然后，**子进程就可以在不影响主线程的情况下，逐一把拷贝的数据写成操作，记入重写日志**。
   + AOF重写过程是非阻塞！非阻塞！非阻塞！，但是AOF写日志是阻塞的，但阻塞的不是当前操作

2. 两处日志（注意缓冲区指的是内存）
   + 第一处日志就是指AOF 日志缓冲区。这样一来，即使宕机了，这个 AOF 日志的操作仍然是齐全的，可以用于恢复。这个操作保证了新来的命令不会丢失
   + 第二处日志就是指**AOF重写日志的缓冲区（区别于AOF日志的缓冲区）**，这样新的AOF日志（AOF重写的）也不会丢失最新的操作。等到拷贝过去的数据全部落盘后，重写日志的缓冲区里面记录的操作也会被更新到新的AOF日志文件中

<img src="/Users/yixia/Desktop/coding-experience/干死小公司妈的/图片/6b054eb1aed0734bd81ddab9a31d0be8.webp"  style="zoom:10%"  />

为啥新来的操作要写两个日志缓冲区（即为啥要写两个日志，不共用一个？）：

这个是一个很有意思的地方。AOF重写是新fork一个线程写的，而主线程里面还在继续写AOF日志。主线程里面的AOF日志有一个AOF缓冲，**它是我们之前讲的三种写回策略，也就是说它一旦写回，这些命令在内存中就没有了。**这个时候新的AOF日志就记录不了这些命令了！！！！但如果有了AOF重写日志缓冲区。**它记录的是从重写开始以后所有的新命令**，**最终它会在AOF重写线程里面，在写完Redis数据拷贝后，一并写到新的AOF日志里面。**

#### 何时触发

有两个配置项在控制AOF重写的触发时机：

1. auto-aof-rewrite-min-size: 表示运行AOF重写时文件的最小大小，默认为64MB
2. auto-aof-rewrite-percentage: 这个值的计算方法是：当前AOF文件大小和上一次重写后AOF文件大小的差值，再除以上一次重写后AOF文件大小。也就是当前AOF文件比上一次重写后AOF文件的增量大小，和上一次重写后AOF文件大小的比值。

AOF文件大小同时超出上面这两个配置项时，会触发AOF重写。